/**
 * @name jquery.Thailand.js
 * @version 1.5.2
 * @update Sep 21, 2017
 * @website https://github.com/earthchie/jquery.Thailand.js
 * @license WTFPL v.2 - http://www.wtfpl.net/
 *
 * @dependencies: jQuery <https://jquery.com/>
 *              zip.js <https://github.com/gildas-lormeau/zip.js> (optional: for zip database_type only)
 *              typeahead.js <https://twitter.github.io/typeahead.js/>
 *              JQL.js <https://github.com/earthchie/JQL.js>
 **/
$.Thailand=function(e){"use strict";e=$.extend({},$.Thailand.defaults,e);var t=function(e){var t,a=[],n=[],i=[],o=!1;return e.lookup&&e.words&&(o=!0,a=e.lookup.split("|"),n=e.words.split("|"),e=e.data),t=function(e){function t(e){var t=e.charCodeAt(0);return n[97>t?t-65:26+t-97]}return o?("number"==typeof e&&(e=a[e]),e.replace(/[A-Z]/gi,t)):e},e[0].length?(e.map(function(e){var a=1;3===e.length&&(a=2),e[a].map(function(n){n[a].map(function(o){o[a]=o[a]instanceof Array?o[a]:[o[a]],o[a].map(function(r){var c={district:t(o[0]),amphoe:t(n[0]),province:t(e[0]),zipcode:r};2===a&&(c.district_code=o[1]||!1,c.amphoe_code=n[1]||!1,c.province_code=e[1]||!1),i.push(c)})})})}),i):e},a=function(e,t,n){e+="",t+="";var i,o,r,c,s=0,p=0,d=0,l=e.length,h=t.length;for(i=0;l>i;i+=1)for(o=0;h>o;o+=1){for(r=0;l>i+r&&h>o+r&&e.charAt(i+r)===t.charAt(o+r);)r+=1;r>d&&(d=r,s=i,p=o)}return c=d,c&&(s&&p&&(c+=a(e.substr(0,p),t.substr(0,p),!1)),l>s+d&&h>p+d&&(c+=a(e.substr(s+d,l-s-d),t.substr(p+d,h-p-d),!1))),n===!1?c:e===t?100:l>h?Math.floor(c/l*100):Math.floor(c/h*100)},n=function(a){var n,i=e.database_type.toLowerCase();switch("json"!==i&&"zip"!==i&&(i=e.database.split(".").pop()),i){case"json":$.getJSON(e.database,function(e){a(new JQL(t(e)))}).fail(function(t){throw new Error('File "'+e.database+'" is not exists.')});break;case"zip":e.zip_worker_path||$("script").each(function(){var e=this.src.split("/"),t=e.pop();"zip.js"===t&&(zip.workerScriptsPath=e.join("/")+"/")}),n=new XMLHttpRequest,n.responseType="blob",n.onreadystatechange=function(){if(4===n.readyState){if(200!==n.status)throw new Error('File "'+e.database+'" is not exists.');zip.createReader(new zip.BlobReader(n.response),function(e){e.getEntries(function(e){e[0].getData(new zip.BlobWriter,function(e){var n=new FileReader;n.onload=function(){a(new JQL(t(JSON.parse(n.result))))},n.readAsText(e)})})})}},n.open("GET",e.database),n.send();break;default:throw new Error('Unknown database type: "'+e.database_type+'". Please define database_type explicitly (json or zip)')}};n(function(t){$.Thailand.DB=t;var n,i,o={empty:" ",suggestion:function(e){return e.zipcode&&(e.zipcode=" » "+e.zipcode),"<div>"+e.district+" » "+e.amphoe+" » "+e.province+e.zipcode+"</div>"}},r=function(t,a){for(n in e)i=n.replace("$",""),n.indexOf("$")>-1&&e.hasOwnProperty(n)&&e[n]&&a[i]&&e[n].typeahead("val",a[i]).trigger("change");"function"==typeof e.onDataFill&&(delete a.likely,e.onDataFill(a))};for(n in e)n.indexOf("$")>-1&&"$search"!==n&&e.hasOwnProperty(n)&&e[n]&&e[n].typeahead({hint:!0,highlight:!0,minLength:1},{limit:e.autocomplete_size,templates:o,source:function(e,a){var n=[],i=this.$el.data("field");try{n=t.select("*").where(i).match("^"+e).orderBy(i).fetch()}catch(o){}a(n)},display:function(e){return e[this.$el.data("field")]}}).parent().find(".tt-dataset").data("field",n.replace("$",""));e.$search&&e.$search.typeahead({hint:!0,highlight:!0,minLength:2},{limit:e.autocomplete_size,templates:o,source:function(e,n){var i=[];try{i=new JQL(i.concat(t.select("*").where("zipcode").match(e).fetch()).concat(t.select("*").where("province").match(e).fetch()).concat(t.select("*").where("amphoe").match(e).fetch()).concat(t.select("*").where("district").match(e).fetch()).map(function(e){return JSON.stringify(e)}).filter(function(e,t,a){return a.indexOf(e)==t}).map(function(t){return t=JSON.parse(t),t.likely=[5*a(e,t.district),3*a(e,t.amphoe.replace(/^เมือง/,"")),a(e,t.province),a(e,t.zipcode)].reduce(function(e,t){return Math.max(e,t)}),t})).select("*").orderBy("likely desc").fetch()}catch(o){}n(i)},display:function(e){return""}});for(n in e)n.indexOf("$")>-1&&e.hasOwnProperty(n)&&e[n]&&e[n].bind("typeahead:select typeahead:autocomplete",r).blur(function(){this.value||$(this).parent().find(".tt-dataset").html("")});"function"==typeof e.onLoad&&e.onLoad(),"function"==typeof e.onComplete&&e.onComplete()})},$.Thailand.defaults={database:"../database/db.json",database_type:"auto",zip_worker_path:!1,autocomplete_size:20,onLoad:function(){},onDataFill:function(){},$district:!1,$district_code:!1,$amphoe:!1,$amphoe_code:!1,$province:!1,$province_code:!1,$zipcode:!1,$search:!1},$.Thailand.setup=function(e){$.extend($.Thailand.defaults,e)};